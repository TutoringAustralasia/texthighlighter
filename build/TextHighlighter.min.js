/*
The MIT License (MIT)

Copyright (c) 2011 - 2016 mirz <mirz.hq@gmail.com>

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/
!function(a){"use strict";function b(a,b){return r(a).color()===r(b).color()}function c(a,b){var c;a=a||{};for(c in b)b.hasOwnProperty(c)&&void 0===a[c]&&(a[c]=b[c]);return a}function d(a){return a.filter(function(a,b,c){return c.indexOf(a)===b})}function e(a){var b=a.startContainer,c=a.endContainer,d=a.commonAncestorContainer,e=!0;if(0===a.endOffset){for(;!c.previousSibling&&c.parentNode!==d;)c=c.parentNode;c=c.previousSibling}else c.nodeType===p.TEXT_NODE?a.endOffset<c.nodeValue.length&&c.splitText(a.endOffset):a.endOffset>0&&(c=c.childNodes.item(a.endOffset-1));return b.nodeType===p.TEXT_NODE?a.startOffset===b.nodeValue.length?e=!1:a.startOffset>0&&(b=b.splitText(a.startOffset),c===b.previousSibling&&(c=b)):b=a.startOffset<b.childNodes.length?b.childNodes.item(a.startOffset):b.nextSibling,{startContainer:b,endContainer:c,goDeeper:e}}function f(a,b){a.sort(function(a,c){return r(b?c:a).parents().length-r(b?a:c).parents().length})}function g(a){function b(a,b){for(var c=Math.min(a.length,b.length),d=0;d<c;){if(a[d]!==b[d])return a[d]-b[d];d++}return a.length-b.length}a.sort(function(a,c){return b(a[2].split(":"),c[2].split(":"))})}function h(a){var b=[],c={},d=[];return a.forEach(function(a){var d=a.getAttribute(o);"undefined"==typeof c[d]&&(c[d]=[],b.push(d)),c[d].push(a)}),b.forEach(function(a){var b=c[a];d.push({chunks:b,timestamp:a,toString:function(){return b.map(function(a){return a.textContent}).join("")}})}),d}function i(a,b){a.addEventListener("mouseup",m),a.addEventListener("touchend",m)}function j(a,b){a.removeEventListener("mouseup",m),a.removeEventListener("touchend",m)}function k(a,b){var c,d=[];do c=Array.prototype.slice.call(a.parentNode.childNodes),d.unshift(c.indexOf(a)),a=a.parentNode;while(a!==b||!a);return d}function l(a,b){if(!a)throw"Missing anchor element";this.el=a,this.options=c(b,{enabled:!0,color:"#ffff7b",highlightedClass:"highlighted",contextClass:"highlighter-context",tagName:"span",keepRange:!1,onRemoveHighlight:function(){return!0},onBeforeHighlight:function(){return!0},onAfterHighlight:function(){}}),r(this.el).addClass(this.options.contextClass),m=this.highlightHandler.bind(this),this.options.enabled&&i(this.el,this)}var m,n="data-highlighted",o="data-timestamp",p={ELEMENT_NODE:1,TEXT_NODE:3},q=["SCRIPT","STYLE","SELECT","OPTION","BUTTON","OBJECT","APPLET","VIDEO","AUDIO","CANVAS","EMBED","PARAM","METER","PROGRESS"],r=function(a){return{addClass:function(b){a.classList?a.classList.add(b):a.className+=" "+b},removeClass:function(b){a.classList?a.classList.remove(b):a.className=a.className.replace(new RegExp("(^|\\b)"+b+"(\\b|$)","gi")," ")},prepend:function(b){for(var c=Array.prototype.slice.call(b),d=c.length;d--;)a.insertBefore(c[d],a.firstChild)},append:function(b){var c,d,e=Array.prototype.slice.call(b);for(c=0,d=e.length;c<d;++c)a.appendChild(e[c])},insertAfter:function(b){return b.parentNode.insertBefore(a,b.nextSibling)},insertBefore:function(b){return b.parentNode.insertBefore(a,b)},remove:function(){a.parentNode&&a.parentNode.removeChild(a),a=null},contains:function(b){return a!==b&&a.contains(b)},wrap:function(b){return a.parentNode&&a.parentNode.insertBefore(b,a),b.appendChild(a),b},unwrap:function(){var b,c=Array.prototype.slice.call(a.childNodes),d=[];return c.forEach(function(a){b=a.parentNode,r(a).insertBefore(a.parentNode),d.push(b)}),d.forEach(function(a){r(a).remove()}),c},parents:function(){for(var b,c=[];b=a.parentNode;)c.push(b),a=b;return c},normalizeTextNodes:function(){if(a){if(a.nodeType===p.TEXT_NODE)for(;a.nextSibling&&a.nextSibling.nodeType===p.TEXT_NODE;)a.nodeValue+=a.nextSibling.nodeValue,a.parentNode.removeChild(a.nextSibling);else r(a.firstChild).normalizeTextNodes();r(a.nextSibling).normalizeTextNodes()}},color:function(){return a.style.backgroundColor},fromHTML:function(a){var b=document.createElement("div");return b.innerHTML=a,b.childNodes},getRange:function(){var b,c=r(a).getSelection();return c.rangeCount>0&&(b=c.getRangeAt(0)),b},removeAllRanges:function(){var b=r(a).getSelection();b.removeAllRanges()},getSelection:function(){return r(a).getWindow().getSelection()},getWindow:function(){return r(a).getDocument().defaultView},getDocument:function(){return a.ownerDocument||a}}};l.prototype.destroy=function(){j(this.el,this),r(this.el).removeClass(this.options.contextClass)},l.prototype.highlightHandler=function(){this.doHighlight()},l.prototype.doHighlight=function(a){if(a="undefined"==typeof a?this.options.keepRange:a,!this.options.enabled)return!1;var b,c,d,e,f=r(this.el).getRange();f&&!f.collapsed&&(this.options.onBeforeHighlight(f)===!0&&(e=+new Date,b=l.createWrapper(this.options),b.setAttribute(o,e),c=this.highlightRange(f,b),d=this.normalizeHighlights(c),this.options.onAfterHighlight(f,d,e)),a||r(this.el).removeAllRanges())},l.prototype.highlightRange=function(a,b){if(!a||a.collapsed)return[];var c,d,f,g=e(a),h=g.startContainer,i=g.endContainer,j=g.goDeeper,k=!1,l=h,m=[];do j&&l.nodeType===p.TEXT_NODE&&(q.indexOf(l.parentNode.tagName)===-1&&""!==l.nodeValue.trim()&&(d=b.cloneNode(!0),d.setAttribute(n,!!this.options.color),f=l.parentNode,(r(this.el).contains(f)||f===this.el)&&(c=r(l).wrap(d),m.push(c))),j=!1),l!==i||i.hasChildNodes()&&j||(k=!0),l.tagName&&q.indexOf(l.tagName)>-1&&(i.parentNode===l&&(k=!0),j=!1),j&&l.hasChildNodes()?l=l.firstChild:l.nextSibling?(l=l.nextSibling,j=!0):(l=l.parentNode,j=!1);while(!k);return m},l.prototype.normalizeHighlights=function(a){var b;return this.flattenNestedHighlights(a),this.mergeSiblingHighlights(a),b=a.filter(function(a){return a.parentElement?a:null}),b=d(b),b.sort(function(a,b){return a.offsetTop-b.offsetTop||a.offsetLeft-b.offsetLeft}),b},l.prototype.flattenNestedHighlights=function(a){function c(){var c=!1;return a.forEach(function(d,f){var g=d.parentElement,h=g.previousSibling,i=g.nextSibling;e.isHighlight(g)&&(b(g,d)?(g.replaceChild(d.firstChild,d),a[f]=g,c=!0):(d.nextSibling||(r(d).insertBefore(i||g),c=!0),d.previousSibling||(r(d).insertAfter(h||g),c=!0),g.hasChildNodes()||r(g).remove()))}),c}var d,e=this;f(a,!0);do d=c();while(d)},l.prototype.mergeSiblingHighlights=function(a){function c(a,c){return c&&c.nodeType===p.ELEMENT_NODE&&b(a,c)&&d.isHighlight(c)}var d=this;a.forEach(function(a){var b=a.previousSibling,d=a.nextSibling;c(a,b)&&(r(a).prepend(b.childNodes),r(b).remove()),c(a,d)&&(r(a).append(d.childNodes),r(d).remove()),r(a).normalizeTextNodes()})},l.prototype.setColor=function(a){this.options.color=a},l.prototype.getColor=function(){return this.options.color},l.prototype.removeHighlights=function(a,b){function c(a){if(!h.isHighlight(a)){var b=a.previousSibling,c=a.nextSibling;b&&b.nodeType===p.TEXT_NODE&&(a.nodeValue=b.nodeValue+a.nodeValue,r(b).remove()),c&&c.nodeType===p.TEXT_NODE&&(a.nodeValue=a.nodeValue+c.nodeValue,r(c).remove())}}function d(a){var b=r(a).unwrap();b.forEach(function(a){c(a)})}var e=a||this.el,g=this.getHighlights({container:e}),h=this;f(g,!0),g.forEach(function(a){h.options.onRemoveHighlight(a)!==!0||"function"==typeof b&&b(a)!==!0||d(a)})},l.prototype.getHighlights=function(a){a=c(a,{container:this.el,andSelf:!0,grouped:!1});var b=a.container.querySelectorAll("["+n+"]"),d=Array.prototype.slice.call(b);return a.andSelf===!0&&a.container.hasAttribute(n)&&d.push(a.container),a.grouped&&(d=h(d),"last"===a.grouped?d=d[d.length-1]:"first"===a.grouped&&(d=d[0])),d},l.prototype.isHighlight=function(a){return a&&a.nodeType===p.ELEMENT_NODE&&a.hasAttribute(n)},l.prototype.serializeHighlight=function(a){var b=this.el,c=0,d=a.textContent.length,e=k(a,b),f=a.cloneNode(!0);return f.innerHTML="",f=f.outerHTML,a.previousSibling&&a.previousSibling.nodeType===p.TEXT_NODE&&(c=a.previousSibling.length),{wrapper:f,text:a.textContent,path:e.join(":"),offset:c,length:d}},l.prototype.serializeHighlights=function(a){var b=this.getHighlights(a||{}),c=this.el,d=[];return b.chunks&&(b=b.chunks),f(b,!1),b.forEach(function(a){var b=0,e=a.textContent.length,f=k(a,c),g=a.cloneNode(!0);g.innerHTML="",g=g.outerHTML,a.previousSibling&&a.previousSibling.nodeType===p.TEXT_NODE&&(b=a.previousSibling.length),d.push([g,a.textContent,f.join(":"),b,e])}),g(d),JSON.stringify(d)},l.prototype.deserializeHighlight=function(a){var b=this;a.path=a.path.split(":");for(var c,d,e=a.path.pop(),f=b.el;d=a.path.shift();)f=f.childNodes[d];return f.childNodes[e-1]&&f.childNodes[e-1].nodeType===p.TEXT_NODE&&(e-=1),f=f.childNodes[e],c=f.splitText(a.offset),c.splitText(a.length),c.nextSibling&&!c.nextSibling.nodeValue&&r(c.nextSibling).remove(),c.previousSibling&&!c.previousSibling.nodeValue&&r(c.previousSibling).remove(),r(c).wrap(r().fromHTML(a.wrapper)[0])},l.prototype.deserializeHighlights=function(a){function b(a){for(var b,c,f,g={wrapper:a[0],text:a[1],path:a[2].split(":"),offset:a[3],length:a[4]},h=g.path.pop(),i=e.el;f=g.path.shift();)i=i.childNodes[f];i.childNodes[h-1]&&i.childNodes[h-1].nodeType===p.TEXT_NODE&&(h-=1),i=i.childNodes[h],b=i.splitText(g.offset),b.splitText(g.length),b.nextSibling&&!b.nextSibling.nodeValue&&r(b.nextSibling).remove(),b.previousSibling&&!b.previousSibling.nodeValue&&r(b.previousSibling).remove(),c=r(b).wrap(r().fromHTML(g.wrapper)[0]),d.push(c)}var c,d=[],e=this;if(!a)return d;try{c=JSON.parse(a)}catch(f){throw"Can't parse JSON: "+f}return g(c),c.forEach(function(a){try{b(a)}catch(c){console&&console.warn&&console.warn("Can't deserialize highlight descriptor. Cause: "+c)}}),d},l.prototype.find=function(a,b){var c=r(this.el).getWindow(),d=c.scrollX,e=c.scrollY,f="undefined"==typeof b||b;if(r(this.el).removeAllRanges(),c.find)for(;c.find(a,f);)this.doHighlight(!0);else if(c.document.body.createTextRange){var g=c.document.body.createTextRange();for(g.moveToElementText(this.el);g.findText(a,1,f?4:0)&&(r(this.el).contains(g.parentElement())||g.parentElement()===this.el);)g.select(),this.doHighlight(!0),g.collapse(!1)}r(this.el).removeAllRanges(),c.scrollTo(d,e)},l.prototype.disable=function(){this.options.enabled&&(j(this.el,this),this.options.enabled=!1)},l.prototype.enable=function(){this.options.enabled||(i(this.el,this),this.options.enabled=!0)},l.createWrapper=function(a){var b=document.createElement(a.tagName);return b.style.backgroundColor=a.color,b.className=a.highlightedClass,b},a.TextHighlighter=l}(window),function(a){"use strict";function b(a,b){return function(){b.call(this,a)}}var c="textHighlighter";a.fn.getHighlighter=function(){return this.data(c)},a.fn[c]=function(d){return this.each(function(){var e,f=this;a.data(f,c)||(e=new TextHighlighter(f,d),e.destroy=b(e.destroy,function(b){b.call(e),a(f).removeData(c)}),a.data(f,c,e))})}}(jQuery);